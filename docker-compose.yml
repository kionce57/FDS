# FDS (Fall Detection System) Docker Compose Configuration
# 使用方法:
#   啟動全部:   docker compose up -d
#   只啟動 Web: docker compose up fds-web
#   清理任務:   docker compose --profile cleanup run --rm fds-cleanup
#   重新建置:   docker compose build (程式碼改動後通常 < 30 秒)

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-common-env: &common-env
  LINE_BOT_CHANNEL_ACCESS_TOKEN: ${LINE_BOT_CHANNEL_ACCESS_TOKEN:-}
  LINE_BOT_USER_ID: ${LINE_BOT_USER_ID:-}
  PYTHONUNBUFFERED: "1"

services:
  # ----------------------------------------------------------
  # 主應用程式 - Fall Detection Pipeline (Heavy Image)
  # ----------------------------------------------------------
  fds:
    build:
      context: .
      dockerfile: Dockerfile
    image: fds-app:latest
    container_name: fds-app

    # [模式選擇] 攝像頭設置
    # ---------------------------
    # 1. 真實攝像頭模式:
    #    - 取消下方 `devices` 的註解
    #    - 確保主機上有 /dev/video0
    #    - 修改 config/settings.yaml 的 camera.source 為 0
    #
    # 2. 測試影片模式 (目前):
    #    - 保持 `devices` 註解
    #    - 確保 `volumes` 有掛載 ./tests:/app/tests:ro
    #    - 修改 config/settings.yaml 的 camera.source 為影片路徑
    
    # devices:
    #   - /dev/video0:/dev/video0

    environment:
      <<: *common-env

    volumes:
      - ./data:/app/data
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./tests:/app/tests:ro
      # 掛載原始碼以便部分修改不用重啟 (Python 緩存可能有影響，但 pyc 已停用)
      - ./src:/app/src:ro 

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    logging: *default-logging

    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ----------------------------------------------------------
  # Web Dashboard - FastAPI Frontend (Lightweight Image)
  # ----------------------------------------------------------
  fds-web:
    build:
      context: .
      dockerfile: Dockerfile.web  # Separate lightweight build
    image: fds-web:latest
    container_name: fds-web

    command: ["python", "-m", "src.web.app"]

    environment:
      <<: *common-env

    volumes:
      - ./data:/app/data
      - ./config:/app/config:ro
      - ./logs:/app/logs
      # 關鍵修正: 掛載 src 目錄，讓靜態檔案修改即時生效！
      - ./src:/app/src:ro

    ports:
      - "8000:8000"

    restart: unless-stopped

    logging: *default-logging

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ----------------------------------------------------------
  # 清理排程器 - 使用主程式映像
  # ----------------------------------------------------------
  fds-cleanup:
    build:
      context: .
      dockerfile: Dockerfile
    image: fds-app:latest
    container_name: fds-cleanup

    command: ["python", "-m", "scripts.cleanup_clips"]

    volumes:
      - ./data:/app/data
      - ./config:/app/config:ro

    restart: "no"

    profiles:
      - cleanup
